#!/bin/sh

#SBATCH -N {{ .Node }}
#SBATCH --ntasks-per-node={{ .NtasksPerNode }}
#SBATCH --gpus-per-node={{ .GpusPerNode }}
#SBATCH --mem=0
#SBATCH --cpus-per-task={{ .CpusPerTasks }}

export PMIX_MCA_pml=ob1
export PMIX_MCA_btl=vader,self,tcp
export OMPI_MCA_pml=ob1
export OMPI_MCA_btl=vader,self,tcp

srun  --mpi=pmix_v4 --cpu-bind=none --gpu-bind=none --container-image="$(pwd)/hpc-benchmarks:21.4-hpl.sqsh" \
  --container-mounts="$(pwd)/hpl.dat:/test.dat" sh -c 'sed -Ei "s/:1//g" ./hpl.sh && ./hpl.sh --xhpl-ai --cpu-affinity 6-7:6-7:2-3:2-3 --cpu-cores-per-rank {{ .CpusPerTasks }} --gpu-affinity 0:0:1:1 --dat "/test.dat"'
